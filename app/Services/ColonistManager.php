<?php
namespace App\Services;
use App\Models\Game; use App\Models\Task; use App\Models\Colonist; use App\Services\Pathfinder;
class ColonistManager { protected $pathfinder; public function __construct(Pathfinder $pf=null){$this->pathfinder=$pf;} public function assign(Game $game): void { $tasks = Task::where('game_id',$game->id)->where('status','pending')->orderByDesc('priority')->get(); $colonists = Colonist::whereIn('player_id',$game->players()->pluck('id'))->get(); foreach($tasks as $task){ if($task->assigned_colonist_id) continue; $best=null;$bestDist=PHP_INT_MAX; foreach($colonists as $c){ $cs=$c->state??[]; if(($cs['action']??null)!=='idle') continue; $cx=$cs['x']??0;$cy=$cs['y']??0; $payload = $task->payload ?? []; $tx = $payload['x'] ?? ($payload['tx'] ?? 0); $ty = $payload['y'] ?? ($payload['ty'] ?? 0); $d = sqrt(pow($tx-$cx,2)+pow($ty-$cy,2)); if($d<$bestDist){$bestDist=$d;$best=$c;} } if($best){ $task->assigned_colonist_id=$best->id; $task->status='assigned'; $task->save(); $state=$best->state??[]; $state['action']='moving_to_task'; $state['target_task_id']=$task->id; $best->state=$state; $best->save(); } } } }
